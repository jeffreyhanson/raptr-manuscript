---
title: "rapr: Representative and Adequate Prioritisations in R"
author: |
  | Jeffrey O. Hanson$^1$, Jonathan R. Rhodes$^2$, Hugh P. Possingham$^1$, Richard A. Fuller$^1$
  | $^1$School of Biological Sciences, The University of Queensland, Brisbane, QLD, Australia
  | $^2$School of Geography, Planning and Environmental Management, The University of Queensland, Brisbane, QLD, Australia
  | Correspondance should be addressed to jeffrey.hanson@uqconnect.edu.au
date: "`r format(Sys.time(), '%d %B %Y')`"
tags: ["conservation", "biodiversity", "MILP", "reserve-selection"]
abstract: "A central aim in conservation is to maximise the long-term persistence of biodiversity. To fulfil this aim, reserve networks are used to safeguard biodiversity patterns (eg. species, populations) and processes (eg. evolutionary processes that underpin genetic variation). Reserve selection is often formulated as an optimisation problem to identify cost-effective prioritisations. However, most existing decision support tools are based on formulations that are well suited for preserving biodiversity patterns, but not biodiversity processes. To fill this gap in the conservation planning toolbox, we developed the \texttt{rapr R} package. This \texttt{R} package provides a toolkit to guide reserve selection using novel formulations of this problem. Here, we explore the functionality of this R package using a simulation study and two case-studies. We demonstrate how explicitly considering biodiversity processes can alter a prioritisation. In most cases, we found that only a few additional plannning units are required to sufficiently preserve of biodiversity processes."
output:
  rmarkdown::pdf_document:
    toc: false
    keep_tex: yes
    fig_caption: yes
    includes:
      in_header: preamble-latex.tex
fontsize: 11pt
documentclass: article
bibliography: references.bib
csl: reference-style.csl
vignette: >
  %\VignetteIndexEntry{rapr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include=FALSE}
# set wd
knitr::opts_knit$set(root.dir=normalizePath('../..'))
```

```{r, include=FALSE}
# load .rda file
try(session::restore.session('data/final/results.rda'))

# set options
options(error=NULL)
```

<!--  title page -->
Short running title: Representative and adequate prioritisations \newline
Word count: XXXXX \newline
Number of references: XXXX \newline
Number of figures: XXXX \newline
Number of tables: XXXX \newline
Number of textboxes: XXXX \newline
Number of equations: XXXX \newline
\newpage

## Introduction
<!-- conservation and reserve networks -->
The overarching aim of conservation is to maximise the long-term persistence of biodiversity [@r423; @r255]. To achieve this, conservation actions must preserve biodiversity patterns (eg. species, populations) and the processes that sustain them. One of the major tangible achievements of modern conservation has been the act of setting aside areas for preservation [@r440]. Reserve networks buffer species from threatening processes [eg. urbanisation; @r255] and set the stage for direct management interventions [eg. captive breeding and reintroduction programs; @r290]. However, the resources available for conservation action are limited, and so reserve networks must be sited in places that satisfy conservation objectives for minimum cost [@r255]. To achieve this, reserve selection is often formulated as an optimisation problem and then solved to identify cost-effective candidate reserve systems [prioritisations; @r255].

<!-- biodiversity processes are important -->
To fulfil the overarching aims of conservation, reserve networks must preserve both ecological and evolutionary processes [@r3; @r255]. Ecological processes, such as predator-prey interactions, pollination, and decomposition, are required for biodiversity to persist over short time-scales. Typically, they operate over small geographic domains--with exceptions such as migration and refugial habitats--and can be preserved using suitably large planning units [@r446] that each contain a discrete unit of habitat [@r448]. On the other hand, evolutionary processes are required for biodiversity to persist over long time-scales, and they typically operate over large geographic domains. Protected areas must preserve adaptive evolutionary processes to foster resilience against environmental change [eg. climate change; @r247]. Protected areas must also preserve neutral evolutionary processes [@r5; @r67; @r63]. These processes are associated with the breakdown of gene flow between populations. They are important for maintaining genetic diversity, and avoiding inbreeding depression. In recent decades, a wealth of data on biodiversity processes has become available to conservation planners [eg. bioclimatic, genetic, and trait data; @r33; @r453; @481]. Yet this data is only rarely used to guide conservation planning [@r61]. This is due to that fact that existing reserve selection tools focus on preserving biodiversity patterns or processes--but not both.

<!-- parametrisation of biodiversity patterns and processes in conventional conservation planning tools -->
Many decision support tools have been developed to help identify cost-effective prioritisations [eg. \texttt{ ConsNet}, @r446; \texttt{ Marxan}, @r22; \texttt{ Zonation}, @r429]. Typically, these tools are used to deliver a prioritisation that preserves a set of target species (or features). Given a set of species, decision makers can use these tools to preserve biodiversity patterns by generating a prioritisation that secures an adequate proportion of each species' range. These tools, however, are not well-suited for biodiversity processes [but see @r203]. To preserve biodiversity processes, a prioritisation must preserve a representative sample of each species. For instance, to preserve predator-prey interactions, a prioritisation must preserve individuals from each predator and prey species in the same area. To preserve adaptive evolutionary processes, a prioritisation must preserve the adaptive landscape of each species--it must preserve individuals experiencing different selection pressures [@r63]. To preserve neutral evolutionary processes, a prioritisation must secure individuals descended from each of the genetic lineages that comprise each species [@r5]. To accommodate such information into a multi-species conservation planning exercise, species ranges must be partitioned into different groups [eg. using habitat data; @r2] as a pre-processing step to be compatible with existing tools. However, this approach assumes that the biodiversity processes that operate across a species' range can be split into discrete units. Yet data on biodiversity processes is often continuous and hyper-dimensional, and often cannot be reduced to a few categories without significant information loss [@r218].

<!-- aims of this paper -->
Today, one of the key issues in reserve selection is the lack of a unifying decision support tool that can accommodate data on biodiversity patterns and processes in a multi-species context. To fill this void, we present the \texttt{rapr R} package. This \texttt{R} package uses novel formulations of the reserve selection problem to provide decision makers with the tools to generate prioritisations that preserve biodiversity patterns and processes. We also explore the functionality of this \texttt{R} package using simulated species and a case-study conservation planning scenario.

## Problem formulations
The \texttt{rapr R} package uses two novel formulations of the reserve selection problem to identify cost-effective prioritisations. These formulations share many constraints and variables. For brevity, the variables used by both formulations will be defined. Biodiversity features are defined as the entity(s) that the prioritisation is required to preserve (eg. species, populations). Spatial attributes are defined as the variation across the species' range that the prioritisation is required to sample. They can be intrinsic (eg. genetic or trait variation) or extrinsic (eg. environmental variation) to the feature. These attributes should be related to the biodiversity processes that the decision maker aims to preserve.

Each attribute is conceptualised as a space. This space is termed an "attribute space". Each planning unit is thought to occupy a single point inside each space. For example, a decision maker may require a prioritisation that preserves populations along climatic gradients. To achieve this, the decision maker might use an "climatic" attribute space with dimensions relating to mean annual temperature ($^{\circ}$C) and precipitation (mm). Any given combination of temperature and precipitation may be conceived as a point in this environmental space. By associating planning units with climatic data, they can be mapped from geographic space to this environmental attribute space.

Demand points are points that also exist in an attribute space. They are designated by the decision maker to indicate regions of the attribute space that should be preserved in the prioritisation (see below for discussion on how demand points can be generated for real-world datasets). The amount of variation in the attribute space that a prioritisation secures is a function of the distance between each demand point and each selected planning unit in the attribute space. The shorter the distances between the demand points and the planning units; the better the prioritisation is at securing the variation in the spatial attribute. To convert these amounts to a proportion--a meaningful unit for a decision maker--the distances between the selected planing units and the demand points are scaled by the distances between the demand points to the centroid of the demand points. In any attribute space there may exist points that are impossible (eg. mean annual rainfall -5 mm), do not occur in the study area (eg. mean annual temperature 30$^{\circ}$C in Antarctica). Additionally, there may be some regions that are desirable for some features and undesirable for others (eg. conditions known to be outside the physiological tolerance of a species). Thus a different set of demand points and weights are used for each attribute space and each feature. By placing demand points in desirable regions of an attribute space for a given feature, the decision maker can ensure that prioritisations secure the feature in planning units with spatial attributes that are desirable for that feature.

To illustrate these concepts, we will briefly describe a conservation planning scenario example involving an attribute spaces and demand points. A decision maker may wish to develop a prioritisation for a single species. This species has four populations in the study area. However, the decision maker can only afford to preserve three population. The decision maker needs to preserve the adaptive landscape of the species, and preserve populations inhabiting different environmental conditions. To describe environmental variaiton, the decision maker obtained data on the environmental conditions (rainfall (ml) and temperature ($^{\circ}$C)) where each population was found. The decision maker then used this environmental data to construct a two-dimensional environmental attribute space. Next, the decision maker generated demand points as equi-distant points between the range of values where the populations were found [$\pm$ 20% to avoid edge effects; @r218]. By comparing the distribution of the demand points to the distribution of the populations in the attribute space, the decision maker can identify a suitable prioritisation (Figure 1). We can see that if the decision maker preserves both populations $A$ and $C$, they will effectively "double-up" on the same environmental characteristics, and in turn their waste resources. Instead, a more representative sample of the intra-specific variation could be preserved by securing populations $A$, $B$, and $D$. This example demonstrates how the inclusion of biodiversity processes can guide the reserve selection process.

The problem formulations used to guide reserve selection in the \texttt{rapr R} package are based on a combination of the \texttt{Marxan} reserve selection problem and the uncapacitated facility location problems [@r451]. All mathematical terms defined hereafter are described in Table S1 for convenience. For convenience, the cardinality of sets will be denoted using the same symbol used to denote the variable. Define $F$ to be the set of features (indexed by $f$). Let $J$ be a set of planning units (indexed by $j$). Also, let $A_j$ denote the area, and $C_j$ denote the cost of preserving planning unit $j \in J$. To assess the extent to which each feature is secured in a given prioritisation, let $q_{fj}$ denote the probability of feature $f$ occupying planning unit $j$. The level of fragmentation associated with a prioritisation is parametrised as the net exposed boundary length. Let the shared edges between each planning unit $j \in J$ and $k \in J$ be $e_{jk}$.

Let $S$ denote a set of attribute spaces (indexed by $s$). Each $j \in J$ is associated with spatially explicit data that represent coordinates for each attribute space $s \in S$. Let $I_{fsi}$ denote a set of demand points (indexed by $i$) for each feature $f \in F$ and each attribute space $s \in S$. Let $\lambda_{fsi}$ denote the weighting for each demand point $i \in I$, $f \in F$ and $s \in S$. Let $d_{fsij}$ denote the distance between each demand point $i \in I$ and each planning unit $j \in J$ for each feature $f \in F$ and attribute space $s \in S$. To describe the inherent variation in the distribution of demand points for feature $f$ and space $s$, let $\delta_{fsi}$ denote the distance between each demand point $i \in I$ and the centroid of the demand points. Demand points with greater weight $\lambda_{fsi}$ are more important, and the optimal solution will be likely to select planning units close to highly weighted demand points. As a consequence, the decision maker will need to choose an appropriate weighting for each demand point.

Targets are used to ensure that prioritisations adequately preserve each species. Amount-based targets are used to ensure that the total amount of habitat preserved is sufficient. Let $T_f$ denote the expected amount of area that needs to be preserved for each feature $f \in F$. Space-based targets ensure that a sufficient proportion of the intra-specific variation is secured. Let $\tau_{fs}$ denote the space-based targets for feature $f \in F$ and attribute space $a \in A$. For convenience, these both types of targets are expressed as proportions in the \texttt{R} package.

The \texttt{R} package provides two formulations for reserve selection. They are based on the unreliable [@r451] and reliable uncapacitated facility location [@r16] problems. The key difference between them is that the reliable formulation explicitly considers the probability that the planning units are occupied when calculating the proportion of variation that a given solution secures, whereas the unreliable formulation does not.

### Unreliable formulation
In the unreliable formulation, the control variables are the $B$, $T_{s}$, and $\tau_{sa}$ variables.

\begin{align*}
T_s &= \text{amount target for feature $f$} \tag{1a}\\
%
\tau_{sa} &= \text{representation target for feature $f$ in attribute space $a$} \tag{1b}\\
%
B &= \text{boundary length modifier (BLM): penalise fragmented solutions} \tag{1c}\\
\end{align*}

The decision variables are the $X_j$ and $Y_{fsij}$ variables.

\begin{align*}
X_j
	&= \begin{cases}
		1, & \parbox{25em}{if planning unit $j$ is selected for conservation action} \tag{2a} \\
		0, & \parbox{25em}{otherwise} \\
	\end{cases} \\
%
Y_{fsij} &= \begin{cases}
		1, & \parbox{25em}{if demand point $i$ is assigned to planning unit $j$ for feature $f$ in space $s$. } \tag{2b} \\
		0, & \parbox{25em}{otherwise} \\
	\end{cases} \\
\end{align*}

Each demand point $i \in I$ for feature $f \in F$ and space $s \in S$ is assigned to a selected planning unit $J$ where $X_j = 1$. The weighted distance between the demand point and its assigned planning unit $\lambda_{fsi} d_{fsij}$ is used to assess how well the demand point is represented in  a given solution. Generally, demand points are assigned to the closest selected planning units (unless particularly low space-based targets are used).

The unreliable formulation (URAP) is a defined as a multi-objective optimisation problem.

\begin{align*}
& \text{(URAP)} & \text{Min } & \sum_{j=0}^{J-1} \left( X_j C_j \right) + \sum_{j=0}^{J-1} \sum_{k=j}^{J-1} X_j \left( 1-X_k \right) \left( B e_{jk} \right) + & & \tag{3a} \\
%
& & \text{s.t. } & \sum_{j=0}^{J-1} A_j q_{fj} \geq T_{f} & \forall & 0 \leq f \leq F-1 \tag{3b}\\
%
& & & 1 - \frac{\sum_{i=0}^{I-1} \sum_{j=0}^{J-1} \left( \lambda_{fsi} d_{fsij} Y_{fsij} \right)^2}{\sum_{i=0}^{I-1} \left( \lambda_{fsi} \delta_{fsi} \right)^2 } \geq \tau_{fs}  & \forall & 0 \leq f \leq F-1, \tag{3c}\\
& & & & & 0 \leq s \leq S-1\\
%
& & & \sum_{j=0}^{J-1} Y_{fsij} = 1 & \forall & 0 \leq f \leq F-1, \tag{3d}\\
& & & & & 0 \leq s \leq S-1, \\
& & & & & 0 \leq i \leq I-1\\
%
& & & Y_{fsij} \leq X_j & \forall & 0 \leq f \leq F-1, \tag{3e}\\
& & & & & 0 \leq s \leq S-1, \\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J-1\\
%
& & & X_j, Y_{fsij} \in {0,1} & \forall & 0 \leq f \leq F-1, \tag{3f}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1\\
%
\end{align*}

The objective function (3a) determines the utility of a given prioritisation: a combination of the total cost of a prioritisation and how fragmented it is. Constraints (3b) ensure that all the amount-based targets are met. Constraints (3c) ensure that all the space-based targets are met for each feature and each attribute space. For each feature and attribute space, the total weighted distance between the demand points and their closest selected planning units is calculated ($\lambda_{fsi} d_{fsij} Y_{fsij}$). This total weighted distance is then scaled by the inherent variation in the demand points ($\lambda_{fsi} \delta_{fsi}$). The resulting fraction yields a proportion conceptually similar to the statistical $R^2$ value, and the constraints ensure that this proportion must be greater than or equal to the space-based target. Constraints (3d) ensure that only one planning unit is assigned to each demand point. Constraints (3e) ensure that demand points are only assigned to selected planning units. Constraints (3f) ensure that the $X$ and $Y$ variables are binary.

### Reliable formulation
The reliable formulation explicitly considers the probability that the planning units are inhabited. As a consequence, it may deliver prioritisations that will sufficiently represent an attribute space even if the features do not inhabit several of the planning units when the prioritisation is implemented. This behaviour is achieved by siting back-up planning units near selected planning units with low occupancy probabilities in the attribute space(s). To ensure that prioritisations are robust against multiple planning units being uninhabited, the problem assigns planning units at multiple backup levels. 

Backup levels levels are defined as $r$-levels [similar to failure levels in @r18]. The first backup $r$-level is used to calculate the level of representation when all of the selected planning units are occupied by all $f \in F$. For this scenario, the closest selected planning unit to each demand point $i$ for attribute space $s$ is assigned at $r$-level$=0$. This scenario essentially represents $Y_{fsij}$ in the unreliable formulation. The second backup $r$-level is used to assess the level of representation when the closest planning unit to each demand point $i$ is unoccupied. For this scenario, the second closest planning units are assigned at $r$-level$=1$. The third backup $r$-level is used to assess representation when the first two closest planning units are unoccupied. The third closest planning units are assigned at $r$-level$=2$. Continuing on, in this manner, the selected planning units in a prioritisation are assigned to each demand point $i \in I$, attribute space $s \in S$, and each feature $f \in F$ at an $r$-level.

A final backup $r$-level when $r=R$ is used to assess the level of representation when the features $f \in F$ do not occupy any selected planning units in a prioritisation. Each demand point $i \in I$ for each $s \in S$ and $f \in F$ is assigned to an "imaginary" planning unit $j=J$ at $r=R$. The distance variables associated with this imaginary planning unit $d_{fsiJ}$ denote the loss of biological value associated with failing to secure a representative sample of feature $f$ in attribute space $s$. However, the $d$ variables are in distance units which are meaningless in this context. Thus these variables are calculated using a failure multiplier ($M$) and the maximum distance between the planning units and the demand points for $f \in F$, $s \in S$ (4).

\begin{align*}
& d_{fsiJ} = M \max\limits_{0 \leq i \leq I-1, 0 \leq j \leq J-1} d_{fsij} & \forall & 0 \leq f \leq F-1, \tag{4} \\
& & & 0 \leq s \leq S-1\\
\end{align*}

Moderately-sized conservation planning problems often include several thousand planning units. It is currently not be feasible to solve this problem when considering all possible failure scenarios. As a consequence, the $R$ variable can be any $1 \leq R \leq J-1$. For instance, when $R=3$ only 2 backup levels are considered in addition to the final backup level. Cui et al. [-@r16] found that $R=5$ yields similar solutions to $R=J$ when $J >> 5$. However, in most costs the decision maker will likely be limited to $R=1$ to obtain prioritisations in a feasible amount of time.

In the reliable formulation, the control variables are the $B$ (1a), $T_{s}$ (1b), $\tau_{sa}$ (1c), $R$, and $M$ variables.

\begin{align*}
R &= \parbox{25em}{number of failure levels} \tag{5a} \\
%
M &= \parbox{25em}{failure multiplier} \tag{5b}\\
%
\end{align*}

The decision variables are the $X_j$ (2a), $Y_{fsijr}$, $P_{fsijr}$ variables.

\begin{align*}
Y_{fsijr} &= \begin{cases}
		1, & \parbox{25em}{if demand point $i$ is assigned to planning unit $j$ for feature $f$ in space $s$ at back-up level $r$. } \tag{6a} \\
		0, & \parbox{25em}{otherwise} \\
	\end{cases} \\
%
P_{fsijr} &= \parbox{25em}{probability that demand point $i$ is assigned to planning unit $j$ at back-up level $r$ for feature $f$ and space $s$} \tag{6a}\\
%
\end{align*}

The reliable formulation (RRAP) is a multi-objective optimisation problem.

\begin{align*}
& \text{(RRAP)} & \text{Min } & \text{(3a)}\\
%
& & \text{s.t. } & \text{(3b)}\\
%
& & & 1 - \frac{\sum_{i=0}^{I-1} \sum_{j=0}^{J-1} \left( \lambda_{fsi} d_{fsij} P_{fsijr} Y_{fsij} \right)^2}{\sum_{i=0}^{I-1} \left( \lambda_{fsi} \delta_{fsi} \right)^2 } \geq T_{fs}  & \forall & 0 \leq f \leq F-1, \tag{7a}\\
& & & & & 0 \leq s \leq S-1\\
%
& & & \sum_{j=0}^{J-1} Y_{fsijr} = 1 & \forall & 0 \leq f \leq F-1, \tag{7b}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq r \leq R\\
%
& & & \sum_{r=0}^{R} Y_{fsijr} = 1 & \forall & 0 \leq f \leq F-1, \tag{7c}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J\\
%
& & & \sum_{r=0}^{R-1} Y_{fsijr} \leq X_j & \forall & 0 \leq f \leq F-1, \tag{7d}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J-1\\
%
& & & Y_{fsiJR} = 1 & \forall & 0 \leq f \leq F-1, \tag{7e}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1\\
%
& & & P_{fsij0} = q_{fj} & \forall & 0 \leq f \leq F-1, \tag{7f}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J\\
%
& & & P_{fsijr} = \left(1 - \right) \sum_{k=0}^{J-1} \frac{1 - q_k}{q_k} P_{f,s,i,k,r-1} Y_{f,s,i,k,r-1}  & \forall & 0 \leq f \leq F-1, \tag{7g}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J,\\
& & & & & 1 \leq r \leq R\\
%
& & & X_j, Y_{fsijr} \in {0,1} & \forall & 0 \leq f \leq F-1, \tag{7h}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J,\\
& & & & & 0 \leq r \leq R\\
\end{align*}

The objective function for the reliable formulation is the same as for the unreliable formation (3a). Similar to the unreliable formulation, constraints (3b) and (7a) ensure that the amount-based and space-based targets are met. Constraint (7b--7c) ensure that each planning unit is only assigned to one backup $r$-level for $i \in I$. Constraints (7d) ensure that only selected planning units are assigned to demand points $i \in I$. Constraints (7e) ensure that the imaginary planning unit is always assigned to the highest backup $r$-level. Constraints (7f--7g) determine the probability that planning unit $j$ will be used to sample demand point $i \in I$ for $s \in S$ and $f \in F$ [see @r16 for more information]. Constraints (7h) ensure that the $X$ and $Y$ variables are binary.

### Optimisation
The unreliable and reliable formulations are non-linear. However, the non-linear components can be linearised using existing techniques. First, the expression $X_j X_k$ in (3a) can be linearised using methods described by Beyer et al. [-@r426]. Second, the expression $P_{fsijr} Y_{jsijr}$ in (7a) can be linearised using techniques described by Sherali and Alameddine [-@r20] as implemented in Cui et al. [-@r16]. Linearised versions of the problems can be solved using commercial exact algorithm solvers.

The \texttt{rapr} R package provides functions to express conservation planning data as an optimisation problems using linearised versions of the unreliable and reliable formulations. These optimisation problems can then be solved to generate prioritisations using the commercial \texttt{Gurobi} software suite (\url{http://www.gurobi.com}). Presently, academics can obtain a license at no cost from the Gurobi website. After installing the \texttt{Gurobi} software suite, users will need to install the \texttt{Gurobi R} package. This \texttt{R} package can be installed on recent Windows, Mac OSX, and Ubuntu Linux operating systems.

To understand the beaviour of this problem and showcase its utility, we conducted a simulation study and two case-studies. These studies involved generating prioritizations using only amount-based targets to represent prioritisations generated using conventional methods (eg. Marxan), and prioritizations using amount-based and space-based targets using the unreliable formulation. 

## Simulation study
### Methods
We generated a study area with planning units arranged in $`r sqrt(sim.params.LST[[MODE]]$number.planning.units)` \times `r sqrt(sim.params.LST[[MODE]]$number.planning.units)`$ square grid (Figure 2). We then simulated three species. The first species was simulated to represent a hyper-generalist--occurring in all planning units with equal probability (Figure 2a). This species' distribution was based on a uniform distribution (eqn 8a). The second species was simulated to represent a species with an idealised distribution (Figure 2b). It has a core range area, and is less likely to be found in areas that are distant from the core area. This species' distribution was simulated using the probability density function of a single multivariate normal distribution (eqn 8b). The third species represents a species with two distinct populations (Figure 2c). This species' distribution was simulated to depict a bimodal distribution, based on the combination of the probability density functions of two multivariate normal distributions (eqn 8c). The probability that each species inhabited a given planning unit was calculated using the $X, Y$ coordinates of the planning unit and eqns 8a--8c. We used a geographic attribute space to showcase the behavior of the problem. For each species, demand points were generated by calculating the centroids of each planning units and their weights were set as the probability that the planning units were occupied. 

\begin{align*}
& P (\text{uniform species} | x, y) &= 0.1 & \tag{8a}\\
& P (\text{normal species} | x, y) &= XXXX & \tag{8b}\\
& P (\text{uniform species} | x, y) &= XXX & \tag{8c}\\
\end{align*}

We generated four prioritisations for each species. First to represent prioritisations generated using conventional conservation planning methods, we generated prioritisations using only `r sim.params.LST[[MODE]]$amount.target*100` % amount targets. Second to show how the addition of geographic targets can affect a prioritisation, we  generated prioritisations using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and `r (sim.params.LST[[MODE]]$space.target*100)` % geographic targets. Third to represent prioritisations using conventional planning methods that penalise for fragmentation, we generated prioritisations using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and a boundary length modifier of `r sim.params.LST[[MODE]]$blm`. Fourth to illustrate the combined affect using geographic targets and penalising fragmentation, we generated prioritisations using using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and `r (sim.params.LST[[MODE]]$space.target*100)` % geographic targets and a boundary length modifier of `r sim.params.LST[[MODE]]$blm`.

### Results



## Case-study 1
### Methods
Here we investigated how space-based targets can be used in a multi-species planning context to generate a prioritisation that sufficiently preserves the realised niche for several species. We selected Queensland, Australia as the study area. This region is ideal for exploring the potential of niche-based targets because it contains a broad range of different habitats. We obtained data for 19 bioclimatic variables across the region [at $30^{\prime \prime}$ resolution from \url{www.worldclim.org}; @r33] and subject them to a principal components analysis (using ArcMap 10.3.1). We used the first `r as.character(as.english(cs1.params.LST[[MODE]]$n.pc.layers))` principle components (cumulatively explained `r round(cs1.pca.DF[[4]][cs1.params.LST[[MODE]]$n.pc.layers],1)` % of the total variation) to characterise the environmental variation across the study area (Figure 3).

We used four bird species in this case study: blue-winged kookaburra (_Dacelo leachii_), brown-backed honeyeater (_Ramsayornis modestus_), the brown falcon (_Falco berigora_), and the pale headed rosella (_Platycercus adscitus_). We used these bird species because they have different evolutionary histories and life-history strategies. We then mapped the extent of occurrence for each species using the following method: we obtained observation data from the Atlas of Living Australia across the whole of Australia [using the \texttt{ALA4R R} package; @r453], spatially thinned the data to omit points within `r cs1.params.LST[[MODE]]$thin.distance/1000` km$^2$ of each other to ameliorate the effects of sampling bias [using the developmental version of the \texttt{spThin R} package; \url{www.github.com/mlammens/spThin}; @r454], and fit `r cs1.params.LST[[MODE]]$mcp.percent` % minimum convex polygons [using the \texttt{adehabitatHR R} package; @r455]. We used this method because it is reproducible using freely available data and moderately accurate. 

We generated `r cs1.params.LST[[MODE]]$dp.number` demand points for each species (Figure S2). To achieve this, for each species, we generated random points inside the species range and at each point extracted the principal component values at that location. We then fit hyperbox kernels to the distribution of these points to characterise the realised niche of each species [using a manually chosen bandwidth of `r cs1.params.LST[[MODE]]$dp.bandwidth[1]` and a `r cs1.params.LST[[MODE]]$dp.quantile` quantile to map the core parts of the species' niches; implemented in the \texttt{hypervolume R} package; @r231]. We then generated uniformly distributed points inside the species' kernels and estimated the density of the training points at the uniformly generated points. These uniformly distributed points and associated density estimated were used as demand point coordinates and weights (respectively).

We generated two prioritisations. The first prioritisation was generated using `r cs1.params.LST[[MODE]]$amount.target*100` % amount-based targets for all species. The second prioritisation was generated the same amount-based target with an additional `r cs1.params.LST[[MODE]]$space.target*100` % niche-based for each species. 

### Results

## Case-study 2
### Methods
Here we used of space-based targets to generate a prioritisation to secure a representative sample of a species' intra-specific genetic variation. We used species occurrence and genomic data collected by the international IntraBioDiv project in the European Alps [@r451; see @r452 and @r478 for further explanation of data collection methods]. Although this dataset contains multiple plant species, we used data for the `r  cs2.params.LST[[MODE]]$common.name` (\textit{`r gsub('_', ' ',cs2.params.LST[[MODE]]$species.name,fixed=TRUE)`}). This species was chosen because it provides is locally wide-spread and has been shown to exhibit significant genetic structure [@r454]. Members of the IntraBioDiv project collected data using a $20^{\prime}$ longitude by $21^{\prime}$ latitude grid (approx. 22.3 km $\times$ 25 km; Figure 5a). They visited every second grid cell, and if the `r cs2.params.LST[[MODE]]$common.name` was detected in a cell, samples were collected from three individuals. Samples were genotyped using amplified fragment length polymorphisms [AFLP; @r453], and used to construct matrices denoting the presence/absence of polymorphisms at loci. In total, `r structurer::n.samples(cs2.spp.StructureData.LST[[1]])` individuals were genotyped at `r structurer::n.loci(cs2.spp.StructureData.LST[[1]])` markers.

We used non-metric multi-dimensional scaling [NMDS; using Gower distances to accommodate sparsity; @r459; implemented the \texttt{cluster R} package; @r457] to ordinate the individual-level presence/absence genetic data into two continuous variables [implemented in the \texttt{vegan R} package; @r458]. These continuous variables described the main theme of genetic variation within the species. We calculated the average of the values associated with individuals in each grid cell. These values were used to create a genetic attribute space (Figures 5c and 5d).

The grid cells were used as planning units. The grid-cell averaged ordinations were used to describe the typical genetic characteristics of individuals in the planning unit. Since the number of planning units was relatively small, we used the same grid-cell averaged ordinations as demand points. To ensure that the solutions did not prioritise particularly costly areas that could not be used for conservation action, we included opportunity cost data (Figure 5b). We obtained population density data [obtained at 1 km resolution from the Global Rural-Urban Mapping Project; \texttt{GRUMP V1}; @r456] and estimated the total population density inside each grid cell.

We generated two prioritisations. The first prioritisation was generated using an `r cs2.params.LST[[MODE]]$amount.target*100` % amount-based target. The second prioritisation was generated using the same amount-based target and an additional `r cs2.params.LST[[MODE]]$genetic.target*100` % genetic-based target.

### Results

## Implications and future directions
The \texttt{rapr} R package provides a unified approach to reserve selection. One of the key advantages of the \texttt{rapr R} package is that it is general enough that any spatial variation could be considered an attribute space, regardless of whether this variation is intrinsic or extrinsic to the feature(s). This R package provides decision makers with the tools to generate prioritisations that secure both biodiversity patterns and processes. Additionally, the package contains functionality to accommodate uncertainty in the distribution of features, and also identify suitably connected reserves. Both the simulated and case-study species suggest that conservation planning exercises need to explicitly consider biodiversity processes during the reserve selection process to capture them.

The degree to which a prioritisation truly secures a representative sample of a feature depends on the attribute spaces and distribution of demand points chosen by the decision maker. Ultimately, the space-based targets are set as a proportion based on the distribution of the demand-points. As a consequence, if the decision maker uses an inappropriate set of spatial variables to construct an attribute space, or an inappropriate set of demand points, then the optimal solution will not be an effective prioritisation in reality. We therefore stress that decision makers must carefully consider which biodiversity processes need to preserved in the prioritisation, and what spatial data can be used to map these processes. Note that maximising one process can be detrimental to another. For instance, to maximise the geographic spread of a prioritisation, reserves need to be further away from each other. Whereas, to maximise the connecitivity of a prioritisation, reserves ineed to be closer to each other. To assist in the selection of appropriate demand points, the \texttt{R} package provides several routines for generating demand points (see the `make.DemandPoints` function). These routines essentially use the distribution of a feature in the attribute space to define a polygon. Demand points are then generated as random points within the polygon. A kernel is then fit to the distribution of the feature in the space [using @r231; @r450], and the demand points are weighted based on the estimated density of the feature at the demand points'.

To maximise the long-term persistence of biodiversity--the stated goal of conservation--decision makers need to identify prioritisations that preserve existing patterns of biodiversity and the processes that support them. To achieve this, conservation planners need a decision support tool that can explicitly accommodate biodiversity patterns and processes. Here, we developed the \texttt{rapr R} package to fill this void. By exploring the functionality of this package using several simulated species, we found that including space-based targets can radically change a prioritisation for the simplest of species.

## Acknowledgements
JOH is funded by an Australian Postgraduate Award (APA) scholarship. RAF has an Australian Research Council Future Fellowship. This work was supported by the Centre of Excellence for Environmental Decisions (CEED) and the Landscape Ecology and Conservation Group (LEC) at The University of Queensland.

## References

