---
bibliography: references.bib
csl: reference-style.csl
output:
  rmarkdown::pdf_document:
    fig_caption: yes
    keep_tex: yes
---

```{r, include=FALSE}
# set wd
knitr::opts_knit$set(root.dir=normalizePath('../..'))
```

```{r, include=FALSE}
## initialization
# load .rda file
checkpoint::checkpoint('2016-11-26', R.version='3.3.2', scanForPackages=FALSE)
session::restore.session('data/final/results.rda')

## preliminary processing
for (i in seq_len(nlayers(cs1.bioclim.RAST)))
  cs1.bioclim.RAST@layers[[i]]@file@name <- paste0(getwd(), strsplit(cs1.bioclim.RAST@layers[[i]]@file@name, 'raptr-manuscript')[[1]][[2]])

```

# Introduction

Perhaps the most fundamental aim of conservation is to maximize the long-term persistence of biodiversity [@r423; @r255]. To achieve this, conservation actions must preserve biodiversity patterns (eg. populations, species, ecosystems), but also crucially the processes that sustain them. One of the major tangible achievements of modern conservation has been the act of setting aside areas for preservation [@r484; @r440]. Reserve networks buffer species from gross threatening processes and set the stage for enhanced management interventions [@r465]. Since the resources available for conservation action are limited, protected area networks must be sited in places that satisfy conservation objectives for minimal cost [@r255].

Today, the most widely used conservation planning tools focus on biodiversity patterns [\texttt{Zonation} and \texttt{Marxan}; @r429; @r22]. Decision makers can use these tools to obtain solutions that secure a proportion of the geographic range of each biological feature (populations, species, or ecosystems) of interest by setting targets. One method to incorporate data on the ecological and evolutionary processes that sustain biological features is to conserve a representative sample of the physical attributes that underpin these processes. To achieve this, current methods typically involve partitioning each feature into sub-groups based on an attribute variable that relates to a biodiversity process of interest [@r9; @r247; @r448]. For instance, by dividing species distributions into sub-groups according to habitat discontinuities, and ensuring that each sub-group is represented in the solution, conservation planners can obtain prioritizations that promote adaptive processes [@r2]. However, using this method is challenging because biodiversity often cannot be divided into operational groups for conservation planning without loss of information [@r489; @r490; @r218].

Simply partitioning features based on continuous variables and setting targets for each sub-group may not necessarily result in a solution that secures a representative sample of the continuous variable. For instance, if a feature was split into four sub-features based on a single continuous variable, and a solution captures 10 % of the geographic range of each sub-feature, how much of the original continuous variation does the solution represent? The answer is not immediately clear. If the solution sites reserves evenly along the original variable, then the solution may sample far more than 10 % of the original variation. Alternatively, if the solution sites reserves near the values used to divide the continuous values [as observed when partitioning features based on political boundaries; @r483], then it might sample much less of the original variation. Conventional reserve selection problems cannot differentiate between these solutions--they are both optimal--though the poorer solution may be favored when using additional constraints to reduce cost or fragmentation. This limitation has been known of quite some time [@r218]. In fact, it dates back to some of the earliest reserve selection methods [eg. @r295].

During the early 1990s, Faith and Walker [-@r480] developed a decision support tool (\texttt{DIVERSITY}) to identify prioritizations that secure a representative sample of environmental variation across a study area. Although this method was originally pitched as an alternative to species-based conservation planning [@r481; @r218; @r203], it can also identify solutions that conserve a representative sample of variation across a single species' range. Recent work has built on this reserve selection method by solving problems with more advanced optimization algorithms [@r482]. However, \texttt{DIVERSITY} has limited utility for species-based conservation planning, in part, because it cannot accommodate multiple biological features--unlike more commonly used tools such as \texttt{Marxan} and \texttt{Zonation}. This fundamental limitation means that \texttt{DIVERSITY} is not useful for most conservation planning scenarios.

Conservation planners lack a decision support tool that lets them set explicit targets to obtain solutions that (1) secure an adequate amount of habitat for each feature and (2) a representative sample of the variation in each feature. To begin to fill this gap, here we unite the ideas underpinning \texttt{DIVERSITY} and \texttt{Marxan} into new formulations of the reserve selection problem, and implement them in the \texttt{raptr R} package. This \texttt{R} package provides decision makers with the tools to generate prioritizations based on data that relate to biodiversity patterns and processes. Here, we aim to the provide an in-depth understanding of this \texttt{R} package and explore its functionality.

# Methods
## PROBLEM FORMULATION
Biodiversity features are defined as the entities that the prioritization is required to preserve (eg. species, ecosystems). Here, attributes are defined as the variation across the feature' range that the prioritization is required to sample. They can be intrinsic variation (eg. genetic or trait) variation that is extrinsic to the feature (eg. environmental conditions). There should, however, be a reasonable underlying hypothesis that relates this variation to the biodiversity processes that the decision maker aims to preserve.

A set of attributes is conceptualized as a space (termed an "attribute space"). For example, a decision maker may require a prioritization that represents populations along climatic gradients. To achieve this, the decision maker might use a "climatic" attribute space with dimensions relating to mean annual temperature ($^{\circ}$C) and precipitation (mm). Any given combination of temperature and precipitation may be conceived as a point in this environmental space. Although they exist as polygons, for simplicity, each planning unit may be thought to exist as a single point inside a given attribute space. By associating the planning units with climatic data, and calculating a representative statistic for each planning unit (eg. mean), they can be mapped from geographic space to this environmental attribute space. In addition to planning units, attribute spaces also contain demand points.

Demand points [@r480; @r218; @r203] are designated by the decision maker to indicate regions of the attribute space that they wish to represent in the prioritization (see below for discussion on generating demand points for real-world data sets). The amount of variation in the attribute space that a solution secures depends on the distance between each demand point and each selected planning unit in the attribute space (see below for mathematical formulations). The shorter the distances between the demand points and the planning units selected for prioritization; the better a solution is at securing the variation in the spatial attribute. To calculate the proportion of variation secured in a given solution, the distances are scaled by the distance between the demand points to their centroid (equivalent to calculating R$^2$ values for K-means clustering). In any attribute space there may exist points that are impossible (eg. mean annual rainfall -5 mm), or do not occur in the study area (eg. mean annual temperature 30$^{\circ}$C in Antarctica). Additionally, there may be some regions that are desirable for some features and undesirable for others (eg. conditions known to be outside the physiological tolerance of certain species). Thus a different set of demand points and weights may be appropriate for different attribute spaces and features. By siting demand points in desirable regions of an attribute space for a given feature, the decision maker can ensure that prioritizations secure the feature in planning units with spatial attributes that are desirable or representative for that feature.

To illustrate these concepts, consider the following example: we wish to develop a prioritization for a single species that has four populations. However, we can only afford to preserve three of the four populations. To ensure that we preserve a representative sample, we want to preserve populations inhabiting different environmental conditions. We obtained annual rainfall (mm) and temperature ($^{\circ}$C) data at the location of each population. We used this data to construct a two-dimensional environmental attribute space. Next, we generated demand points as equi-distant points inside this space. By comparing the distributions of demand points and populations in the attribute space, we can identify a suitable prioritization (Fig. 1). We can see that a solution that prioritizes both populations _A_ and _B_, effectively "doubles-up" on the same environmental characteristics and constitute considerable redundancy if both selected. Instead, a more representative sample of the intra-specific variation could be captured by securing populations $A$ (or $B$), $C$, and $D$. However, if the goal of the prioritization was to preserve populations living in warmer temperatures, then instead of siting demand points across the full range of conditions, demand points could be sited in conditions that reflect this goal (eg. the top two rows of demand points in Fig. 1). Given this new set of demand points, populations _A_, _B_, and _C_ would be prioritized. As we have demonstrated, demand points provide a flexible means to guide the reserve selection process.

The \texttt{raptr R} package utilizes two novel formulations of reserve selection problem to generate prioritizations. These formulations are based on elements of the \texttt{Marxan}, \texttt{DIVERSITY}, and uncapacitated facility location problems [@r451]. Since they are based on the unreliable and reliable facility location problems [@r16], the formulations are hereafter referred to as the unreliable and reliable formulations. The difference between the two formulations is that the reliable formulation explicitly considers the probability that planning units are occupied by features when calculating how well a solution samples a feature's attribute space. Whereas, the unreliable formulation assumes that features occupy the planning units in which they are found in with 100 % certainty when calculating how well a solution samples a feature's attribute space. For brevity, we will define the simpler formulation--the unreliable formulation--below and define the more complex version--the reliable formulation--in Appendix S1. All mathematical terms defined hereafter are described in Table S1. For convenience, the cardinality of sets will be denoted using the same symbol used to denote the set.

Define $F$ to be the set of features one wishes to conserve (indexed by $f$). Let $J$ be a set of planning units (indexed by $j$). Also, let $A_j$ denote the area, and $C_j$ denote the cost of preserving planning unit $j \in J$. To assess the extent to which each feature is secured in a given prioritization, let $q_{fj}$ denote the probability of feature $f$ occupying planning unit $j$. The level of fragmentation associated with a prioritization is parameterized as the total exposed boundary length (as in \texttt{Marxan}). Let the shared edges between each planning unit $j \in J$ and $k \in J$ be $e_{jk}$.

Let $S$ denote a set of attribute spaces (indexed by $s$). Each $j \in J$ is associated with spatially explicit data that represent coordinates for each attribute space $s \in S$. Let $I_{fsi}$ denote a set of demand points (indexed by $i$) for each feature $f \in F$ and each attribute space $s \in S$. Let $\lambda_{fsi}$ denote the weighting for each demand point $i \in I$, $f \in F$ and $s \in S$. Let $d_{fsij}$ denote the distance between each demand point $i \in I$ and each planning unit $j \in J$ for each feature $f \in F$ and attribute space $s \in S$. To describe the inherent variation in the distribution of demand points for feature $f$ and space $s$, let $\delta_{fsi}$ denote the distance between each demand point $i \in I$ and the centroid of the demand points. Demand points with greater weight $\lambda_{fsi}$ are more important, and the solutions that select planning units close to highly weighted demand points will be more favorable. As a consequence, the decision maker will need to choose an appropriate weighting for each demand point.

Targets are used to ensure that prioritizations adequately preserve each feature. Amount-based targets are used to ensure that the total amount of habitat preserved is sufficient. Let $T_f$ denote the expected amount of area that needs to be preserved for each feature $f \in F$. Space-based targets ensure that a representative or desirable sample of each feature is secured. Let $\tau_{fs}$ denote the space-based targets for feature $f \in F$ and attribute space $s \in S$. For convenience, all targets are expressed as proportions in the \texttt{R} package.

The control variables for the unreliable formulation are the $B$, $T_{s}$, and $\tau_{fs}$ variables.

\begin{align*}
T_s &= \text{amount target for feature $f$} \tag*{eqn 1a}\\
%
\tau_{fs} &= \parbox{25em}{space-based target for feature $f$ in attribute space $s$ according to the corresponding demand points} \tag*{eqn 1b}\\
%
B &= \text{boundary length modifier (BLM) to penalize fragmented solutions} \tag*{eqn 1c}\\
\end{align*}

The decision variables are the $X_j$ and $Y_{fsij}$ variables.

\begin{align*}
X_j
  &= \begin{cases}
    1, & \parbox{25em}{if planning unit $j$ is selected for conservation action} \tag*{eqn 2a} \\
    0, & \parbox{25em}{otherwise} \\
  \end{cases} \\
%
Y_{fsij} &= \begin{cases}
    1, & \parbox{25em}{if demand point $i$ is used to represent planning unit $j$ for feature $f$ in space $s$. } \tag*{eqn 2b} \\
    0, & \parbox{25em}{otherwise} \\
  \end{cases} \\
\end{align*}

Each demand point $i \in I$ for feature $f \in F$ and space $s \in S$ is assigned to a selected planning unit $J$ where $X_j = 1$. The weighted distance between the demand point and its assigned planning unit $\lambda_{fsi} d_{fsij}$ is used to assess how well the demand point is represented in a given solution. Generally, demand points are represented by their closest selected planning units (unless extremely small space-based targets are used, such as 0.000001, and so the solution effectively unconstrained by the space-based target).

The unreliable formulation (URAP) is a defined as a multi-objective optimization problem.

\begin{align*}
& \text{(URAP)} & \text{Min } & \sum_{j=0}^{J-1} \left( X_j C_j \right) + \sum_{j=0}^{J-1} \sum_{k=j}^{J-1} X_j \left( 1-X_k \right) \left( B e_{jk} \right) + & & \tag*{eqn 3a} \\
%
& & \text{s.t. } & \sum_{j=0}^{J-1} A_j q_{fj} \geq T_{f} & \forall & 0 \leq f \leq F-1 \tag*{eqn 3b}\\
%
& & & 1 - \frac{\sum_{i=0}^{I-1} \sum_{j=0}^{J-1} \lambda_{fsi} {d_{fsij}}^{2} Y_{fsij}}{\sum_{i=0}^{I-1} \lambda_{fsi} {\delta_{fsi}}^{2}} \geq \tau_{fs} & \forall & 0 \leq f \leq F-1, \tag*{eqn 3c}\\
& & & & & 0 \leq s \leq S-1\\
%
& & & \sum_{j=0}^{J-1} Y_{fsij} = 1 & \forall & 0 \leq f \leq F-1, \tag*{eqn 3d}\\
& & & & & 0 \leq s \leq S-1, \\
& & & & & 0 \leq i \leq I-1\\
%
& & & Y_{fsij} \leq X_j & \forall & 0 \leq f \leq F-1, \tag*{eqn 3e}\\
& & & & & 0 \leq s \leq S-1, \\
& & & & & 0 \leq i \leq I-1,\\
& & & & & 0 \leq j \leq J-1\\
%
& & & X_j, Y_{fsij} \in {0,1} & \forall & 0 \leq f \leq F-1, \tag*{eqn 3f}\\
& & & & & 0 \leq s \leq S-1,\\
& & & & & 0 \leq i \leq I-1\\
%
\end{align*}

The objective function (eqn 3a) determines the utility of a given prioritization: a combination of the total cost of a prioritization and how fragmented it is. Constraints (eqn 3b) ensure that all the amount-based targets are met. Constraints (eqn 3c) ensure that all the space-based targets are met for each feature and each attribute space. For each feature and attribute space, the total weighted distance between the demand points and their closest selected planning units is calculated ($\lambda_{fsi} d_{fsij} Y_{fsij}$). This total weighted distance is then scaled by the inherent variation in the demand points ($\lambda_{fsi} \delta_{fsi}$). The resulting fraction yields a proportion conceptually similar to the $R^2$ statistic used in $k$-means clustering analysis. The constraints ensure that this proportion must be equal to or greater than the space-based target. Constraints (eqn 3d) ensure that only one planning unit is assigned to each demand point. Constraints (eqn 3e) ensure that demand points are only assigned to selected planning units. Constraints (eqn 3f) ensure that the $X$ and $Y$ variables are binary.

## Optimization
The unreliable formulation is non-linear. However, the non-linear components can be linearized using existing techniques. The expression $X_j X_k$ in (eqn 3a) can be linearized using methods described by Beyer et al. [-@r426]. The \texttt{raptr} R package provides functions to express conservation planning data as optimization problems using linearized versions of the unreliable and reliable formulations (see Appendix S1 for formulation), and solve them using the commercial \texttt{Gurobi} software suite (\url{www.gurobi.com}). Presently, academics can obtain a license at no cost from the \texttt{Gurobi} website.

# Examples

To understand and showcase the behavior of the unreliable problem, we conducted a simulation study and two case studies. These studies involved generating solutions using only amount targets to represent prioritizations generated using conventional methods (eg. \texttt{Marxan}), and solutions using amount and space targets using the unreliable formulation. By comparing these solutions, we can gauge the benefits of explicitly including space targets in reserve selection. We have also conducted a benchmark analysis to estimate how long it would take to solve various sized problem (Appendix S2). All analyses were performed in \texttt{R} [version `r getRversion()`; @r192] and all optimization problems were solved to within `r general.params.LST[[MODE]]$MIPGap * 100` % of optimality.

## SIMULATION STUDY
### Methods
We simulated a hypothetical study area with planning units arranged in a $`r sqrt(sim.params.LST[[MODE]]$number.planning.units)` \times `r sqrt(sim.params.LST[[MODE]]$number.planning.units)`$ square grid (Fig. 2). We then simulated three species across this study area. The first species was simulated to represent a hyper-generalist--occurring in all planning units with equal probability (Fig. 2a). This species' distribution was based on a uniform distribution (eqn 4a). The second species was simulated to represent a species with an idealized distribution (Fig. 2b). It has a core range area, and is less likely to be found in areas that are distant from the core area. This species' distribution was simulated using the probability density function of a single multivariate normal distribution (eqn 4c). The third species represents a species with two distinct populations (Fig. 2c). This species' distribution was simulated to depict a bimodal distribution, based on the combination of the probability density functions of two multivariate normal distributions (eqn 4d). The probability that each species inhabited a given planning unit was calculated using the $X, Y$ coordinates of the planning unit and eqns 4a--4d. We used a geographic attribute space to showcase the behavior of the problem. For each species, demand points were set as the planing units' centroids and were weighted according to the units' probability of occupancy. 

\begin{align*}
\\
P \left( \text{uniformly distributed species} | \left( x, y \right) \right) &= 0.1 \tag*{eqn 4a} \\
%
f \left(z, \mu, \Sigma \right) &= \left(2 \pi \right) ^{-1} | \Sigma | e ^{- \frac{1}{2} \left(z - \mu \right)' \Sigma ^{-1} \left(z - \mu \right)} \tag*{eqn 4b} \\
%
P \left( \text{normally distributed species} | \left( x , y \right) \right) &= \frac{f \left( \left[ \begin{smallmatrix} x \\ y \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} 0.0 \\ 0.0 \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} 12.58&0 \\ 0&12.5 \end{smallmatrix} \right] \right)}{2} \tag*{eqn 4c} \\
%
P \left( \text{bimodally distributed species} | \left( x,y \right) \right) &= \text{Max} \begin{cases}
f \left(\left[ \begin{smallmatrix} x \\ y \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} -3.75 \\ -3.75 \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} 10&0 \\ 0&10 \end{smallmatrix} \right] \right), \\ \frac{f \left( \left[ \begin{smallmatrix} x \\ y \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} 3.75 \\ 3.75 \end{smallmatrix} \right] \, \left[ \begin{smallmatrix} 8&0 \\ 0&8 \end{smallmatrix} \right] \right)} {2} \\
\end{cases} \tag*{eqn 4d} \\
%
\end{align*}

We generated four solutions for each species. First to represent solutions generated using conventional methods, we generated solutions using only `r sim.params.LST[[MODE]]$amount.target*100` % amount targets. Second to show how the addition of space-based targets can affect a prioritization, we generated solutions using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and `r (sim.params.LST[[MODE]]$space.target*100)` % space targets to ensure that the solution samples the geographic spread of the species (hereafter referred to as geographic spread targets). Third to represent solutions generated using conventional planning methods that penalize for fragmentation, we generated solutions using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and a boundary length modifier of `r sim.params.LST[[MODE]]$blm`. Fourth to illustrate the combined affect using space-based targets and penalising fragmentation, we generated solutions using `r (sim.params.LST[[MODE]]$amount.target*100)` % amount targets and `r (sim.params.LST[[MODE]]$space.target*100)` % geographic spread targets and a boundary length modifier of `r sim.params.LST[[MODE]]$blm`.

### Uniformly distributed species

The uniform species was simulated to occur with a constant probability of occupancy across the study area (Fig. 2a). The solution generated using `r sim.params.LST[[MODE]]$amount.target*100` % amount-based targets (Fig. 3a) selected `r filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount\ntargets')$n` planning units near the southern end of study area. This specific configuration is an artifact of the method used to solve the problem. In fact, for this species, all prioritizations containing `r filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount\ntargets')$n` planning units are optimal when considering only `r sim.params.LST[[MODE]]$amount.target*100` % amount targets. In the absence of additional criteria, reserve selection methods may or may not return solutions that secure a representative sample of the features. In this particular case, the solution does not secure a representative sample of the species' range (`r round(filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount\ntargets')$space.held,2)` % sampled). Note that the proportion here is negative because it performs worse than simply siting a planning unit in the centroid of the species' demand points.

The addition of a `r sim.params.LST[[MODE]]$space.target*100` % geographic spread target resulted in a solution that secured a representative sample of the uniform species' range (`r round(filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount &\nspace targets')$space.held,2)` % sampled; Fig. 3b). Since all planning units have equal cost and an equal chance of being occupied, this solution has the same number of planning units as the solution generated using only amount targets (cf. Fig 3a). Although the use of amount and space based targets has addressed adequacy and representativeness objectives (respectively), they have resulted in a highly fragmented solution.

The addition of a positive boundary length modifier (BLM) parameter resulted in a well-connected solution that secured an adequate proportion (`r round(filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount &\nspace targets')$amount.held,2)` % ) and representative sample (`r round(filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount & space\ntargets and BLM')$space.held,2)` % sampled) of the species geographic spread (Fig. 3d). Although this solution also contains `r filter(sim.spp.DF, species=='Uniform\nspecies', prioritisation=='Amount & space\ntargets and BLM')$n` planning units--the same amount as previously discussed solutions--it secures a representative proportion of the species geographic spread in a configuration that is not highly fragmented. Overall, these results show that under the simplest of conditions, using just amount targets results in an under-specified reserve selection problem that is unlikely to return an effective solution.

### Normally distributed species

The normally distributed species was simulated to contain a single core area where individuals were most prevalent, and marginal areas where individuals were less likely to occur (Fig. 2b). The solution generated using `r sim.params.LST[[MODE]]$amount.target*100` % amount targets contained `r filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount\ntargets')$n` planning units and concentrated conservation efforts in the core area (Fig. 3e). Since all planning units have equal costs and areas, this solution contains the planning units with the highest probabilities of occupancy. Whilst this solution satisfies the adequacy objective for a prioritization in a cost-effective manner--it fails to fulfill the representative objective for a prioritization (`r round(filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount\ntargets')$space.held,2)` % distribution sampled).

The solution generated using `r sim.params.LST[[MODE]]$amount.target*100` % amount targets and `r sim.params.LST[[MODE]]$space.target*100` % geographic spread targets resulted in a solution that is both adequate and representative in terms of the uniform species' distribution (Fig. 3f). This solution used `r filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount &\nspace targets')$n` planning units to secure `r round(filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount &\nspace targets')$amount.held,2)` % and sample `r round(filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount &\nspace targets')$space.held,2)` % of the normal species' distribution. By using amount and geographic spread targets in the reserve selection problem, we obtained a solution that concentrates conservation effort in the range core and also the range margin. However, similar to the corresponding solution for the uniform species (Fig. 3b), this solution is highly fragmented.

By using `r sim.params.LST[[MODE]]$amount.target*100` % amount targets and `r sim.params.LST[[MODE]]$space.target*100` % geographic spread targets and a boundary length modifier parameter ($BLM = 1$), we obtained a solution that fulfills adequacy, representativeness and connectivity objectives (Fig. 3h). This solution contains `r filter(sim.spp.DF, species=='Normal\nspecies', prioritisation=='Amount & space\ntargets and BLM')$n` planning units. Unlike the solution for the uniform species generated using the same parameters, however, this solution contains more planning units than any other solutions for this species (cf. Figs. 3e--3g). These results suggests that the combination of space targets and boundary length modifiers may require solutions that contain more planning units. They also also suggest that space targets can result in solutions that secure a more representative sample of the species--even for species without significant spatial structure.

### Bimodally distributed species

The bimodally distributed species was simulated to represent a species with a highly structured distribution, and it contains two distinct populations (Fig. 2c). The solution generated using just `r sim.params.LST[[MODE]]$amount.target*100` % amount targets prioritized individuals in just one of the two populations (Fig. 3i). While this solution secured an adequate proportion of the species' distribution (`r round(filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount\ntargets')$amount.held,2)` % secured), it did not sample a representative proportion of the range (`r round(filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount\ntargets')$space.held,2)` % sampled). The addition of boundary length modifiers to amount targets resulted in a solution which sampled even less of the species distribution (`r round(filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount target\nand BLM')$space.held,2)` % sampled; Fig. 3k). However, the addition of geographic spread targets resolved these issues.

The solution generated using `r sim.params.LST[[MODE]]$amount.target*100` % amount and `r sim.params.LST[[MODE]]$space.target*100` % geographic spread targets included planning units from both populations (Fig. 3j). Although this solution required more planning units to fulfill both targets ($n=`r filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount &\nspace targets')$n`$), this solution secured a representative sample of the bimodally distributed species (`r round(filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount &\nspace targets')$space.held,2)` % range sampled). Similar to corresponding solution generated for the normally distributed species (Fig. 3f), this solution was also highly fragmented and we could obtain a more well-connected solution at the expense of selecting additional planning units ($n=`r filter(sim.spp.DF, species=='Bimodal\nspecies', prioritisation=='Amount & space\ntargets and BLM')$n`$; Fig. 3l). The results for the bimodally distributed species suggest that species with highly structured populations or strong variation between individuals could benefit the most from prioritizations that are generated using space-based targets.

## CASE STUDY 1
### Methods
We investigated how space-based targets can be used in a multi-species planning context to generate a prioritization that sufficiently preserves the species' realized niches. By preserving the populations in suitable habitats with different environmental conditions, conservation planners can preserve the species' adaptive landscape and foster resilience to environmental change [@r63]. We selected Queensland, Australia as the study area. We obtained data for 19 bioclimatic variables across the region [at $30^{\prime \prime}$ resolution from \url{www.worldclim.org}; @r33] and subjected them to a principal components analysis (using ArcMap 10.3.1). We used the scores from the first `r as.character(as.english(cs1.params.LST[[MODE]]$n.pc.layers))` principal components to characterize the environmental variation across the study area (explaining `r round(cs1.pca.DF[[4]][cs1.params.LST[[MODE]]$n.pc.layers],1)` % of the total variation; Fig. 4).

We used four bird species in this case study: blue-winged kookaburra (_Dacelo leachii_), brown-backed honeyeater (_Ramsayornis modestus_), brown falcon (_Falco berigora_), and pale headed rosella (_Platycercus adscitus_). These species span a range of different habitat requirements. We mapped the extent of occurrence for each species (Fig. 5). To do this, we obtained occurrence records from the Atlas of Living Australia across the whole of Australia [using the \texttt{ALA4R R} package; @r453], spatially thinned the data to omit points within `r cs1.params.LST[[MODE]]$thin.distance/1000` km$^2$ of each other to ameliorate the effects of sampling bias [using the developmental version of the \texttt{spThin R} package; \url{https://github.com/mlammens/spThin}; @r454], and fit `r cs1.params.LST[[MODE]]$mcp.percent` % minimum convex polygons [using the \texttt{adehabitatHR R} package; @r455]. We used this method because it is entirely reproducible using freely available data. 

We generated `r cs1.params.LST[[MODE]]$dp.number` demand points for each species (Fig. S2). To ensure that the demand points reflected the core parts of the species' realized niches, we used the following method. For each species, we generated random points inside the species' geographic range and at each point extracted the principal component values at that location. We then fit hyperbox kernels to the distribution of principal component values to characterize the realized niche of each species using a manually chosen bandwidth of `r cs1.params.LST[[MODE]]$dp.bandwidth[1]` and a `r cs1.params.LST[[MODE]]$dp.quantile` quantile to map the core parts of the species' niches [implemented in the \texttt{hypervolume R} package; @r231]. We then generated uniformly distributed points inside the species' distribution in environmental space, and extracted the kernel density at their locations. These uniformly distributed points and associated density estimations were used as demand point coordinates and weights (respectively).

We generated two solutions. The first solution was generated using `r cs1.params.LST[[MODE]]$amount.target*100` % amount targets for all species. The second solution was generated the same amount target with an additional `r cs1.params.LST[[MODE]]$space.target*100` % niche-based target for each species. 

### Results
Generally, the solution generated using amount targets preserved a representative sample of each the `r as.character(as.english(length(cs1.params.LST[[MODE]]$species.names)))` bird species' niches. (Figure S1). This solution secured over `r cs1.params.LST[[MODE]]$space.target*100` % of the realized niche of `r parsed.representative.space.held.names`. Yet it failed to achieve this for the `r parsed.not.representative.space.held.names`. This result demonstrates that although conventional methods may yield solutions that conserve a representative sample of some features, only through the use of explicit targets can planners obtain cost-effective solutions that secure a representative sample of all features.

## CASE STUDY 2
### Methods
Here we used space-based targets to generate a prioritization securing a representative sample of a species' intra-specific genetic variation. We used species occurrence and genetic data collected by the international IntraBioDiv project in the European Alps [@r463; @r461; @r462]. Although this dataset contains multiple species, we used data for the `r tolower(cs2.params.LST[[MODE]]$common.name)` (\textit{`r gsub('_', ' ',cs2.params.LST[[MODE]]$species.name,fixed=TRUE)`}) as a simple case study, because it has been found to exhibit significant genetic structure [@r462]. Members of the IntraBioDiv project collected data using a $20^{\prime}$ longitude by $21^{\prime}$ latitude grid (approx. 22.3 km $\times$ 25 km; Fig. 7a). They visited every second grid cell, and if the species was detected in a cell, samples were collected from three individuals. Samples were genotyped using amplified fragment length polymorphisms [AFLP; @r472], and used to construct matrices denoting the presence/absence of polymorphisms at loci. In total, `r structurer::n.samples(cs2.spp.StructureData.LST[[1]])` individuals were genotyped at `r structurer::n.loci(cs2.spp.StructureData.LST[[1]])` markers.

We used non-metric multi-dimensional scaling [NMDS; using Gower distances to accommodate sparsity; @r459; implemented using the \texttt{cluster R} package; @r457] to ordinate the presence (or absence) of locus-specific alleles within individuals into two continuous variables [implemented in the \texttt{vegan R} package; @r458]. These continuous variables described the main axes of genetic variation within the species. We averaged together values corresponding to samples collected in the same grid cell, and used them to create a genetic attribute space (Figs. 7c and 7d). To assess spatial auto-correlation, we calculated Moran's I auto-correlation index for each NMDS axis using scaled inverse great circle distances between the grid cells' centroids as weights [using the \texttt{ape R} package; @r464].

The grid cells were used as planning units for generating prioritizations. As previously mentioned, data were not collected in every grid cell, and so the planning units are arranged in a checkerboard pattern. The grid-cell averaged ordinations were used to describe the typical genetic characteristics of individuals in the planning unit. Since the number of planning units was relatively small, we used the same grid-cell averaged ordinations as demand points. To ensure that the solutions did not prioritize particularly costly areas, we obtained population density data [1 km resolution from the Global Rural-Urban Mapping Project; \texttt{GRUMP V1}; @r456] and estimated the total population density inside each grid cell. We used these values to represent opportunity cost (Fig. 7b).

We generated two solutions. The first solution was generated using an `r cs2.params.LST[[MODE]]$amount.target*100` % amount-based target. The second solution was generated using the same amount-based target and an additional `r cs2.params.LST[[MODE]]$genetic.target*100` % genetic-based target.

### Results

A two-dimensional attribute genetic space was able to capture most of the variation between individuals (stress = `r round(cs2.spp.nmds.LST[[1]]$stress,2)`; Figs. 7c--7d). Planning units located near each other contained individuals with similar genetic characteristics (Moran's I: NMDS axis 1, $I = `r round(cs1.nmds.MoransI[[1]][[1]]$observed,2)`$, $P `r pvalString(cs1.nmds.MoransI[[1]][[1]]$p.value)`$; Moran's I: NMDS axis 2, $I = `r round(cs1.nmds.MoransI[[1]][[2]]$observed,2)`$, $P `r pvalString(cs1.nmds.MoransI[[1]][[2]]$p.value)`$). In terms of the average genetic characteristics of individuals in the planning units, they tended to cluster into two main groups, with evidence of within-group structure inside the larger group (Fig 8c). This analysis supports previous work by Alvarez _et al._ [-@r461] who also found evidence of genetic structure within this species.

The solution generated using just the amount target failed to preserve a representative portion of the species' genetic variation (`r round(cs2.spp.DF$genetic[1],2)` % sampled; Figs. 8a and 8c). This solution only conserved individuals in one of the two main genetic groups. In fact, this solution is just a collection of the cheapest planning units occupied by the species needed to fullfil the target. Whereas, the solution generated using both amount and genetic targets conserved individuals in each of the two main genetic groups (`r round(cs2.spp.DF$genetic[2],2)` % sampled; Figs. 8b and 8d). Although the solutions only differ by a single planning unit, by securing individuals in both main genetic groups the second solution was able to secure a much more representative sample of the species' genetic variation for only a minor increase in cost (`r round(cs2.spp.DF$Score[2],2)` compared to `r round(cs2.spp.DF$Score[1],2)` total cost).

# Implications and future directions
The \texttt{raptr R} package provides a unified approach to reserve selection. Conservation planners can use this \texttt{R} package to generate prioritizations that secure intra-specific as well as as inter-specific biodiversity patterns. Additionally, the package contains functionality to accommodate uncertainty in the distribution of features using the reliable formulation (defined in Appendix S1), and ensure that solutions are well-connected. Both the simulated and case study species suggest that explicitly considering representation as well as amount targets can significantly alter prioritizations.

One of the key advantages of this package is that it is general enough to incorporate almost any spatially explicit variable. This package can accommodate intrinsic or extrinsic variation in the feature(s). For example, adaptation processes could be secured using environmental variation [eg. @r247], and trophic processes could be conserved by capturing the overlapping distributions of predator and prey species [eg. @r471; @r485]. Note that maximizing one process can result in trading off against another (eg. geographic spread vs. connectivity). Additionally, space targets can be used to achieve representation for reasons that are not related to biodiversity processes, such as obtaining a geographically representative set of reserves so there is equitable access to parks by people [eg. @r483]. As long as the variation can be described using Euclidean distances--which could be achieved through transformation or dimension reduction--the \texttt{R} package can be used to obtain a representative sample.

The degree to which a prioritization truly secures a representative sample of a feature depends on (1) the attribute space(s), (2) the distribution of demand points chosen by the conservation planner, and (3) the space target used. The optimal solution will not effectively represent the decision maker's objectives if an inappropriate set of spatial variables or demand points are used to represent the attribute space. Demand points should be distributed across the full range of variation in an attribute space to obtain solutions that secure a representative sample of the attribute space (see the `make.DemandPoints` function for statistical routines to achieve this). As with conventional amount-based targets, planners will have to ensure that space targets are high enough to fulfill conservation objectives [eg. when setting targets to conserve intra-specific genetic variation; @r487]. We encourage conservation planners to consult with experts to ensure that appropriate space targets are used.

Attribute data need to be spatially comprehensive to map planning units to attribute spaces. However, many real-world data sets are patchy. For example, due to constrained resources, genetic data may only be available for some planning units. To use such patchy data, planners could omit the planning units that are missing data, or estimate the missing data using spatially explicit models [eg. krigging or generalized dissimilarity models; @r467; @r486]. This approach has been successfully applied to a range of biological data sets [eg. @r468]. We caution that inaccuracy and uncertainty in data can negatively impact prioritizations [@r488], and recommend that planners ensure that data are reliable or accommodate uncertainty into the planning process (eg. by using the reliable formulation).

To maximize the long-term persistence of biodiversity, decision makers need to identify prioritizations that preserve existing patterns of biodiversity and the processes that support them.  To achieve this, conservation planners need a decision support tool that can deliver cost-effective prioritizations that secure an adequate amount of a representative sample of biodiversity features. Here, we developed the \texttt{raptr R} package to fill this void. By exploring the functionality of this package using several simulated and case study species, we found that including space-based targets can result in substantially different solutions.

# Acknowledgements
JOH is funded by an Australian Postgraduate Award (APA) scholarship. RAF and HPP have Australian Research Council Fellowships. This work was supported by the Centre for Biodiversity and Conservation Science (CBCS).

# Data accessibility
The \texttt{raptr R} package can be downloaded from The Comphrehensive R Archive Network (\url{https://CRAN.R-project.org/package=raptr}). All data, code, and results are stored in an online repository (\url{https://github.com/jeffreyhanson/raptr-manuscript}) to permit replication and validation of this study.

# References

\bibliography{references}
